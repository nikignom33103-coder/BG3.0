<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º ‚Äî –ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #f8fafc; color: #334155; }
        .nav-link.active { background: #0f766e; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .tab-btn.active { border-color: #0f766e; color: #0f766e; border-bottom-width: 2px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    <aside class="w-64 bg-slate-900 text-white flex flex-col z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center font-bold">–ë</div>
            <span class="font-bold text-lg">–ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å</span>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-1">
            <p class="px-2 text-xs font-bold text-slate-500 uppercase mb-2">–ú–µ–Ω—é</p>
            <a href="dashboard.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-chart-pie w-6"></i>–°–≤–æ–¥–∫–∞</a>
            <a href="finances.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-money-bill-wave w-6"></i>–§–∏–Ω–∞–Ω—Å—ã</a>
            <a href="shipments.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-truck w-6"></i>–†–µ–π—Å—ã</a>
            <a href="fundraising.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-piggy-bank w-6"></i>–°–±–æ—Ä—ã</a>
            <a href="inventory.html" class="nav-link active flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition"><i class="fas fa-warehouse w-6"></i>–°–∫–ª–∞–¥</a>
            <a href="recipients.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-users w-6"></i>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏</a>
            <a href="team.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-people-group w-6"></i>–ö–æ–º–∞–Ω–¥–∞</a>
            <a href="press.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-newspaper w-6"></i>–ü—Ä–µ—Å—Å-—Ü–µ–Ω—Ç—Ä</a>
            <a href="reports.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-chart-bar w-6"></i>–û—Ç—á–µ—Ç—ã</a>
            <div id="adminBlock" class="hidden mt-6">
                <p class="px-2 text-xs font-bold text-slate-500 uppercase mb-2">–ê–¥–º–∏–Ω</p>
                <a href="users.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-user-shield w-6"></i>–î–æ—Å—Ç—É–ø</a>
                <a href="settings.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-cogs w-6"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-800 flex items-center gap-3">
            <div id="ava" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold"></div>
            <div class="flex-1 min-w-0">
                <p id="myName" class="text-sm font-bold truncate">...</p>
                <p id="myRole" class="text-xs text-slate-400 truncate">...</p>
            </div>
            <button onclick="logout()" class="text-slate-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-[#f1f5f9] overflow-hidden">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 z-10 shadow-sm">
            <h2 class="text-xl font-bold text-slate-800">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º v5.0</h2>
            <div class="flex gap-2">
                <button onclick="openModal('in')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/30"><i class="fas fa-plus mr-2"></i>–ü—Ä–∏—Ö–æ–¥</button>
                <button onclick="openModal('out')" class="bg-amber-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-amber-700 transition shadow-lg shadow-amber-500/30"><i class="fas fa-minus mr-2"></i>–°–ø–∏—Å–∞–Ω–∏–µ</button>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-8">
            <div class="flex border-b border-slate-200 mb-6 gap-6">
                <button onclick="switchTab('sof')" id="tabSof" class="tab-btn active pb-3 px-2 text-sm font-bold transition">–°–∫–ª–∞–¥ –°–æ—Ñ–∏–π—Å–∫–∞—è</button>
                <button onclick="switchTab('pes')" id="tabPes" class="tab-btn pb-3 px-2 text-sm font-bold transition">–°–∫–ª–∞–¥ –ü–µ—Å–æ—á–Ω—ã–π</button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4">–¢–æ–≤–∞—Ä</th>
                            <th class="px-6 py-4">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="px-6 py-4">–û—Å—Ç–∞—Ç–æ–∫</th>
                            <th class="px-6 py-4">–ï–¥. –∏–∑–º.</th>
                            <th class="px-6 py-4 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 text-sm text-slate-700"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Operation Modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <h3 id="modalTitle" class="font-bold text-xl mb-4 text-slate-800">–û–ø–µ—Ä–∞—Ü–∏—è</h3>
            <form id="opForm" onsubmit="event.preventDefault(); showSignModal();" class="space-y-4">
                <input type="hidden" name="type" id="opType">
                
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" name="backdate" id="backdate" class="w-5 h-5 text-blue-600 rounded" onchange="toggleBackdate()">
                        <label for="backdate" class="text-lg font-bold text-blue-800 cursor-pointer">
                            <i class="fas fa-calendar-clock mr-2"></i>–í–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º
                        </label>
                    </div>
                    <div id="dateFields" class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-600 uppercase mb-2">–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                            <input type="date" name="date" class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                        </div>
                        <div id="backdateField" class="hidden">
                            <label class="block text-sm font-bold text-slate-600 uppercase mb-2">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∏—è</label>
                            <input type="date" name="entryDate" class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <p class="text-xs text-blue-700 mt-1 flex items-center gap-1">
                                <i class="fas fa-info-circle"></i>
                                –î–∞—Ç–∞, –∫–æ–≥–¥–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±—ã–ª–∞ –≤–Ω–µ—Å–µ–Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Å–∏—Å—Ç–µ–º—É
                            </p>
                        </div>
                    </div>
                </div>

                <input name="name" list="goods" class="w-full p-3 border border-slate-200 rounded-xl" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required>
                <datalist id="goods"></datalist>
                
                <div class="grid grid-cols-3 gap-4">
                    <input type="number" name="qty" class="w-full p-3 border border-slate-200 rounded-xl" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
                    <input name="unit" class="w-full p-3 border border-slate-200 rounded-xl" placeholder="–ï–¥. –∏–∑–º." value="—à—Ç" required>
                    <select name="category" class="w-full p-3 border border-slate-200 rounded-xl" required>
                        <option value="–æ–¥–µ–∂–¥–∞">–û–¥–µ–∂–¥–∞</option>
                        <option value="–ø—Ä–æ–¥—É–∫—Ç—ã">–ü—Ä–æ–¥—É–∫—Ç—ã</option>
                        <option value="–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã">–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã</option>
                        <option value="—Ç–µ—Ö–Ω–∏–∫–∞">–¢–µ—Ö–Ω–∏–∫–∞</option>
                        <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                        <select name="warehouse" class="w-full p-3 border border-slate-200 rounded-xl" required>
                            <option value="sof">–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥ (–°–æ—Ñ–∏–π—Å–∫–∞—è)</option>
                            <option value="pes">–§–∏–ª–∏–∞–ª (–ü–µ—Å–æ—á–Ω—ã–π)</option>
                            <option value="temp">–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</option>
                            <option value="damaged">–ë—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                        <input name="responsible" class="w-full p-3 border border-slate-200 rounded-xl" placeholder="–§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ" required>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–ò—Å—Ç–æ—á–Ω–∏–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</label>
                    <select name="source" class="w-full p-3 border border-slate-200 rounded-xl">
                        <option value="donation">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ</option>
                        <option value="purchase">–ó–∞–∫—É–ø–∫–∞</option>
                        <option value="transfer">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</option>
                        <option value="return">–í–æ–∑–≤—Ä–∞—Ç</option>
                        <option value="other">–ü—Ä–æ—á–µ–µ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea name="notes" class="w-full p-3 border border-slate-200 rounded-xl h-20" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                </div>
                
                <button class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition">
                    <i class="fas fa-arrow-right mr-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—é
                </button>
            </form>
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Signing Modal -->
    <div id="signModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fas fa-file-contract"></i>
            </div>
            <h3 class="font-bold text-xl text-slate-800 mb-2">–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
            <p class="text-sm text-slate-500 mb-6">–í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –¥–∞–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.</p>
            <div class="p-3 bg-slate-50 rounded-xl mb-6 text-left">
                <p class="text-xs text-slate-400 font-bold uppercase">–ü–æ–¥–ø–∏—Å–∞–Ω—Ç</p>
                <p class="font-bold text-slate-700" id="signName">...</p>
                <p class="text-xs text-slate-500" id="signRole">...</p>
            </div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('signModal').classList.add('hidden')" class="flex-1 py-2 border border-slate-200 rounded-lg font-bold text-slate-600">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="confirmOp()" class="flex-1 py-2 bg-amber-600 text-white rounded-lg font-bold shadow-lg shadow-amber-500/30">–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDRMyiouLjL6oyQK5TIpr69b8mvCcq4uLE", authDomain: "blago-a6270.firebaseapp.com", databaseURL: "https://blago-a6270-default-rtdb.firebaseio.com", projectId: "blago-a6270", storageBucket: "blago-a6270.firebasestorage.app", messagingSenderId: "857823585303", appId: "1:857823585303:web:6ce2d1acff62b16ebd2852", measurementId: "G-YHWJPH8TF9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const user = JSON.parse(localStorage.getItem('blago_user'));
        if(!user) window.location.href = 'index.html';
        
        document.getElementById('myName').innerText = user.name;
        document.getElementById('myRole').innerText = user.role;
        document.getElementById('ava').innerText = user.name[0];
        if(user.role==='admin') document.getElementById('adminBlock').classList.remove('hidden');
        function logout(){localStorage.removeItem('blago_user'); window.location.href='index.html';}

        let inventory = [];
        let currentWarehouse = 'sof';

        db.ref('inventory').on('value', snap => {
            inventory = snap.val() || {};
            render();
        });

        function loadInventory() {
            db.ref('inventory').once('value', snap => {
                inventory = snap.val() || {};
                render();
            });
        }

        function switchTab(w){
            currentWarehouse = w;
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById(w === 'sof' ? 'tabSof' : 'tabPes').classList.add('active');
            render();
        }

        function render() {
            const items = Array.isArray(inventory) ? inventory : Object.entries(inventory || {}).map(([key, val]) => ({...val, firebaseId: key}));
            const list = items.filter(i => i && (i.warehouse || 'sof') === currentWarehouse);
            
            // Calculate summary statistics
            const totalItems = list.length;
            const totalQuantity = list.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
            const criticalItems = list.filter(item => parseInt(item.quantity) < 10).length;
            const lowItems = list.filter(item => parseInt(item.quantity) >= 10 && parseInt(item.quantity) < 50).length;
            
            // Update summary
            document.getElementById('summaryTotal').textContent = totalItems;
            document.getElementById('summaryQuantity').textContent = totalQuantity;
            document.getElementById('summaryCritical').textContent = criticalItems;
            document.getElementById('summaryLow').textContent = lowItems;
            
            document.getElementById('tableBody').innerHTML = list.map(i => {
                const quantity = parseInt(i.quantity) || 0;
                const statusClass = quantity < 10 ? 'text-red-600' : quantity < 50 ? 'text-yellow-600' : 'text-emerald-600';
                const statusText = quantity < 10 ? '–ö—Ä–∏—Ç–∏—á–Ω–æ' : quantity < 50 ? '–ú–∞–ª–æ' : '–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ';
                const statusBadge = quantity < 10 ? 'bg-red-100 text-red-700' : quantity < 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-emerald-100 text-emerald-700';
                
                return `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center font-bold text-slate-600 text-sm shadow-inner">
                                    ${getCategoryIcon(i.category)}
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-slate-800">${i.name}</div>
                                    ${i.notes ? `<div class="text-xs text-slate-500 mt-1 line-clamp-2">${i.notes.substring(0, 80)}${i.notes.length > 80 ? '...' : ''}</div>` : ''}
                                    ${i.responsible ? `<div class="text-xs text-slate-400 mt-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${i.responsible}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">${i.category || '–û–±—â–µ–µ'}</div>
                            <div class="text-xs text-slate-400">${getWarehouseName(i.warehouse || 'sof')}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div class="font-mono font-bold ${statusClass} text-lg">${quantity}</div>
                                <div class="text-xs text-slate-400">${i.unit}</div>
                            </div>
                            <div class="mt-1">
                                <span class="px-2 py-1 rounded-full text-xs font-bold ${statusBadge}">
                                    ${statusText}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-slate-600">${i.unit}</div>
                            ${i.source ? `<div class="text-xs text-slate-400">${getSourceLabel(i.source)}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-slate-500">
                                ${i.createdAt ? new Date(i.createdAt).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </div>
                            ${i.updatedAt ? `<div class="text-xs text-slate-400">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(i.updatedAt).toLocaleDateString('ru-RU')}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick='viewInventoryItem("${i.firebaseId || i.id}")' class="p-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick='printInventoryDoc("${i.firebaseId || i.id}")' class="p-2 text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg transition" title="–ü–µ—á–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button onclick='addInventoryOperation("${i.firebaseId || i.id}")' class="p-2 text-purple-500 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition" title="–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button onclick='editInventoryItem("${i.firebaseId || i.id}")' class="p-2 text-green-500 hover:text-green-700 hover:bg-green-50 rounded-lg transition" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick='deleteInventoryItem("${i.firebaseId || i.id}")' class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('') || `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center">
                        <div class="text-slate-400">
                            <i class="fas fa-box-open text-4xl mb-4"></i>
                            <p class="text-lg font-medium">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p class="text-sm">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Helper functions for inventory display
        function getCategoryIcon(category) {
            const icons = {
                '–æ–¥–µ–∂–¥–∞': 'üëï',
                '–ø—Ä–æ–¥—É–∫—Ç—ã': 'üçé',
                '–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã': 'üíä',
                '—Ç–µ—Ö–Ω–∏–∫–∞': 'üì±',
                '–≥–∏–≥–∏–µ–Ω–∞': 'üß¥',
                '–¥–µ—Ç—Å–∫–∏–µ': 'üß∏',
                '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ': 'üî®',
                '–¥—Ä—É–≥–æ–µ': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        function getWarehouseName(warehouse) {
            const names = {
                'sof': '–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥',
                'pes': '–§–∏–ª–∏–∞–ª (–ü–µ—Å–æ—á–Ω—ã–π)',
                'temp': '–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ',
                'damaged': '–ë—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã',
                'out': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                'distributed': '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'
            };
            return names[warehouse] || warehouse;
        }

        function getSourceLabel(source) {
            const labels = {
                'donation': '–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ',
                'purchase': '–ó–∞–∫—É–ø–∫–∞',
                'transfer': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
                'return': '–í–æ–∑–≤—Ä–∞—Ç',
                'other': '–ü—Ä–æ—á–µ–µ'
            };
            return labels[source] || source;
        }

        function toggleBackdate() {
            const checkbox = document.getElementById('backdate');
            const backdateField = document.getElementById('backdateField');
            backdateField.classList.toggle('hidden', !checkbox.checked);
        }

        function openModal(type){
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('opType').value = type;
            document.getElementById('modalTitle').innerText = type === 'in' ? '–ü—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–∞' : '–°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
            
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            const form = document.getElementById('opForm');
            form.reset();
            form.type.value = type;
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            document.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0];
            
            // –°–∫—Ä—ã—Ç—å –ø–æ–ª—è –∑–∞–¥–Ω–µ–π –¥–∞—Ç—ã
            document.getElementById('backdateField').classList.add('hidden');
            document.getElementById('backdate').checked = false;
        }
        
        function closeModal(){ 
            document.getElementById('modal').classList.add('hidden'); 
        }

        function showSignModal() {
            document.getElementById('signName').innerText = user.name;
            document.getElementById('signRole').innerText = user.role;
            document.getElementById('signModal').classList.remove('hidden');
        }

        function editInventoryItem(id) {
            const items = Array.isArray(inventory) ? inventory : Object.values(inventory || {});
            const item = items.find(x => (x.firebaseId || x.id) === id || x.id === parseInt(id));
            if(!item) return;
            
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            const form = document.getElementById('opForm');
            form.type.value = 'in'; // –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥
            form.date.value = item.createdAt ? new Date(item.date).toISOString().split('T')[0] : '';
            form.name.value = item.name;
            form.qty.value = item.quantity;
            form.unit.value = item.unit;
            form.category.value = item.category || '–¥—Ä—É–≥–æ–µ';
            form.warehouse.value = item.warehouse || 'sof';
            form.responsible.value = item.responsible || '';
            form.source.value = item.source || 'donation';
            form.notes.value = item.notes || '';
            
            // –ò–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const confirmBtn = document.querySelector('#signModal button[onclick="confirmOp()"]');
            confirmBtn.innerText = '–û–±–Ω–æ–≤–∏—Ç—å';
            confirmBtn.onclick = (e) => updateInventoryItem(e, id);
            
            document.getElementById('modal').classList.remove('hidden');
        }

        async function updateInventoryItem(e, id) {
            e.preventDefault();
            const f = document.getElementById('opForm');
            
            const updatedItem = {
                name: f.name.value,
                quantity: parseInt(f.qty.value),
                unit: f.unit.value,
                category: f.category.value,
                warehouse: f.warehouse.value,
                responsible: f.responsible.value,
                source: f.source.value,
                notes: f.notes.value,
                updatedAt: new Date().toLocaleString('ru-RU'),
                updatedBy: JSON.parse(localStorage.getItem('blago_user')).name
            };

            try {
                await db.ref('inventory').child(id).update(updatedItem);
                
                alert(`‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!`);
                closeModal();
                loadInventory();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
            }
        }

        function deleteInventoryItem(id) {
            const items = Array.isArray(inventory) ? inventory : Object.values(inventory || {});
            const item = items.find(x => (x.firebaseId || x.id) === id || x.id === parseInt(id));
            if(confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${item?.name}" –∏–∑ —Å–∫–ª–∞–¥–∞?`)) {
                db.ref('inventory').child(id).remove(() => {
                    alert('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∫–ª–∞–¥–∞');
                    loadInventory();
                });
            }
        }

        async function confirmOp() {
            const f = document.getElementById('opForm');
            const type = f.type.value;
            const qty = parseInt(f.qty.value);
            
            if (!f.name.value.trim() || !qty || qty <= 0) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            const isBackdated = document.getElementById('backdate').checked;
            const entryDate = isBackdated ? 
                (f.entryDate.value ? new Date(f.entryDate.value).toLocaleDateString('ru-RU') : new Date().toLocaleDateString('ru-RU')) :
                new Date().toLocaleDateString('ru-RU');
            
            const dateStr = new Date(f.date.value).toLocaleDateString('ru-RU');
            const user = JSON.parse(localStorage.getItem('blago_user'));
            
            const newItem = {
                type: type,
                date: dateStr,
                entryDate: entryDate,
                name: f.name.value,
                quantity: qty,
                unit: f.unit.value,
                category: f.category.value,
                warehouse: f.warehouse.value,
                responsible: f.responsible.value,
                source: f.source.value,
                notes: f.notes.value,
                createdBy: user.name,
                createdAt: new Date().toLocaleString('ru-RU'),
                status: 'active',
                updatedAt: new Date().toLocaleString('ru-RU')
            };

            try {
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
                await db.ref('inventory').push(newItem);
                
                // –ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞
                printInventoryOperation(newItem);
                
                alert(`‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è "${type === 'in' ? '–ü—Ä–∏—Ö–æ–¥' : '–°–ø–∏—Å–∞–Ω–∏–µ'}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
                
                document.getElementById('signModal').classList.add('hidden');
                closeModal();
                loadInventory();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function generateSignatureHash(formData) {
            const data = JSON.stringify(formData);
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function printInventoryOperation(item) {
            const w = window.open('','','width=900,height=1000');
            const warehouseNames = {
                'sof': '–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥ (–°–æ—Ñ–∏–π—Å–∫–∞—è)',
                'pes': '–§–∏–ª–∏–∞–ª (–ü–µ—Å–æ—á–Ω—ã–π)',
                'temp': '–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ',
                'damaged': '–ë—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã'
            };
            
            const sourceNames = {
                'donation': '–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ',
                'purchase': '–ó–∞–∫—É–ø–∫–∞',
                'transfer': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
                'return': '–í–æ–∑–≤—Ä–∞—Ç',
                'other': '–ü—Ä–æ—á–µ–µ'
            };

            w.document.write(`
                <html><head><title>–°–∫–ª–∞–¥—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Ññ ${item.id}</title>
                <style>
                    @page { size: A4; margin: 20mm; }
                    body { font-family: 'Times New Roman', serif; padding: 0; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
                    .doc-title { font-size: 24px; font-weight: bold; margin: 20px 0; }
                    .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .info-table th, .info-table td { border: 1px solid #000; padding: 8px; font-size: 12px; }
                    .info-table th { background: #f5f5f5; text-align: left; font-weight: bold; }
                    .signatures-section { margin-top: 40px; }
                    .signature-row { display: flex; justify-content: space-between; margin: 30px 0; }
                    .signature-box { width: 45%; border: 1px solid #000; padding: 15px; }
                    .signature-title { font-weight: bold; margin-bottom: 10px; }
                    .signature-line { margin-top: 20px; border-bottom: 1px solid #000; height: 30px; }
                    .pep-stamp { border: 2px solid #2563eb; color: #2563eb; padding: 15px; font-weight: bold; background: #f8fafc; margin-top: 20px; }
                </style>
                </head><body>
                <div class="header">
                    <h2>–í–û–õ–û–ù–¢–ï–†–°–ö–ê–Ø –ì–†–£–ü–ü–ê ¬´–ë–õ–ê–ì–û –î–ê–†–ò–¢–¨¬ª</h2>
                    <div class="doc-title">${item.type === 'in' ? '–ü–†–ò–•–û–î–ù–´–ô –û–†–î–ï–†' : '–ê–ö–¢ –°–ü–ò–°–ê–ù–ò–Ø'} ‚Ññ ${item.id}</div>
                    <div>–î–∞—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</div>
                </div>
                
                <table class="info-table">
                    <tr>
                        <th width="30%">–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏:</th>
                        <td>${item.date}</td>
                    </tr>
                    <tr>
                        <th>–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏:</th>
                        <td>${item.entryDate}</td>
                    </tr>
                    <tr>
                        <th>–¢–æ–≤–∞—Ä:</th>
                        <td>${item.name}</td>
                    </tr>
                    <tr>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</th>
                        <td>${item.quantity} ${item.unit}</td>
                    </tr>
                    <tr>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</th>
                        <td>${item.category}</td>
                    </tr>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:</th>
                        <td>${warehouseNames[item.warehouse] || item.warehouse}</td>
                    </tr>
                    <tr>
                        <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</th>
                        <td>${item.responsible}</td>
                    </tr>
                    <tr>
                        <th>–ò—Å—Ç–æ—á–Ω–∏–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è:</th>
                        <td>${sourceNames[item.source] || item.source}</td>
                    </tr>
                </table>

                ${item.notes ? `
                    <h3 style="margin: 20px 0 10px 0;">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</h3>
                    <div style="border: 1px solid #ccc; padding: 10px; min-height: 50px;">
                        ${item.notes}
                    </div>
                ` : ''}

                <div class="signatures-section">
                    <h3 style="margin-bottom: 15px;">–ü–æ–¥–ø–∏—Å–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏—Ü:</h3>
                    
                    <div class="signature-row">
                        <div class="signature-box">
                            <div class="signature-title">–°–æ–∑–¥–∞—Ç–µ–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞:</div>
                            <div>–ü–æ–¥–ø–∏—Å–∞–ª: ${item.signatures.creator.signerName}</div>
                            <div>–†–æ–ª—å: ${item.signatures.creator.signerRole}</div>
                            <div>–î–∞—Ç–∞: ${new Date(item.signatures.creator.signedAt).toLocaleString('ru-RU')}</div>
                            <div>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${item.signatures.creator.comment}</div>
                            <div class="signature-line"></div>
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">–ü–æ–¥–ø–∏—Å—å</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-title">–ü–µ—á–∞—Ç—å –∏ –ø–æ–¥–ø–∏—Å—å:</div>
                            <div class="signature-line"></div>
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">–ú.–ü.</div>
                            <div class="signature-line" style="margin-top: 30px;"></div>
                            <div style="text-align: center; font-size: 12px;">–ü–æ–¥–ø–∏—Å—å</div>
                        </div>
                    </div>
                </div>

                <div class="pep-stamp">
                    <strong>–≠–õ–ï–ö–¢–†–û–ù–ù–ê–Ø –ü–û–î–ü–ò–°–¨ –î–û–ö–£–ú–ï–ù–¢–ê</strong><br>
                    –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: ${item.createdAt}<br>
                    –°–æ–∑–¥–∞—Ç–µ–ª—å: ${item.createdBy}<br>
                    –•–µ—à –¥–æ–∫—É–º–µ–Ω—Ç–∞: SHA256:${btoa(`${item.createdBy}:${item.date}:${item.id}:${item.name}`).replace(/=/g, '')}
                </div>
                </body></html>
            `);
            w.document.close();
        }

        function printInventoryDoc(id) {
            const item = inventory.find(x => x.id === id);
            if(!item) return;
            
            const w = window.open('','','width=900,height=1000');
            w.document.write(`
                <html><head><title>–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ ‚Ññ ${id}</title>
                <style>
                    @page { size: A4; margin: 20mm; }
                    body { font-family: 'Times New Roman', serif; padding: 0; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
                    .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .info-table th, .info-table td { border: 1px solid #000; padding: 8px; font-size: 12px; }
                    .info-table th { background: #f5f5f5; text-align: left; font-weight: bold; }
                </style>
                </head><body>
                <div class="header">
                    <h2>–í–û–õ–û–ù–¢–ï–†–°–ö–ê–Ø –ì–†–£–ü–ü–ê ¬´–ë–õ–ê–ì–û –î–ê–†–ò–¢–¨¬ª</h2>
                    <h3>–ö–ê–†–¢–û–ß–ö–ê –¢–û–í–ê–†–ê ‚Ññ ${id}</h3>
                </div>
                
                <table class="info-table">
                    <tr>
                        <th width="30%">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</th>
                        <td>${item.name}</td>
                    </tr>
                    <tr>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</th>
                        <td>${item.quantity} ${item.unit}</td>
                    </tr>
                    <tr>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</th>
                        <td>${item.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                    </tr>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:</th>
                        <td>${item.warehouse || '–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥'}</td>
                    </tr>
                    <tr>
                        <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</th>
                        <td>${item.responsible || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    </tr>
                    <tr>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</th>
                        <td>${item.createdAt || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                    </tr>
                    <tr>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</th>
                        <td>${item.updatedAt || '–ù–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å'}</td>
                    </tr>
                </table>

                ${item.notes ? `
                    <h3 style="margin: 20px 0 10px 0;">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</h3>
                    <div style="border: 1px solid #ccc; padding: 10px; min-height: 50px;">
                        ${item.notes}
                    </div>
                ` : ''}
                </body></html>
            `);
            w.document.close();
        }
    </script>
</body>
</html>