<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–¥–∏–Ω—ã–π –∂—É—Ä–Ω–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Äî –ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #f8fafc; color: #334155; }
        .nav-link.active { background: #0f766e; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    <aside class="w-64 bg-slate-900 text-white flex flex-col z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center font-bold">–ë</div>
            <span class="font-bold text-lg">–ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å</span>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-1">
            <p class="px-2 text-xs font-bold text-slate-500 uppercase mb-2">–ú–µ–Ω—é</p>
            <a href="dashboard.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-chart-pie w-6"></i>–°–≤–æ–¥–∫–∞</a>
            <a href="shipments.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-truck w-6"></i>–û—Ç–ø—Ä–∞–≤–∫–∏</a>
            <a href="recipients.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-users w-6"></i>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏</a>
            <a href="inventory.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-warehouse w-6"></i>–°–∫–ª–∞–¥</a>
            <a href="team.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-people-group w-6"></i>–ö–æ–º–∞–Ω–¥–∞ CRM</a>
            <a href="documents.html" class="nav-link active flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition"><i class="fas fa-file-contract w-6"></i>–ñ—É—Ä–Ω–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</a>
            <a href="reports.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-chart-bar w-6"></i>–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å</a>
            <div id="adminBlock" class="hidden mt-6">
                <p class="px-2 text-xs font-bold text-slate-500 uppercase mb-2">–ê–¥–º–∏–Ω</p>
                <a href="users.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-user-shield w-6"></i>–î–æ—Å—Ç—É–ø</a>
                <a href="settings.html" class="nav-link flex items-center px-3 py-2.5 rounded-xl text-sm font-medium transition hover:bg-white/10"><i class="fas fa-cogs w-6"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-800 flex items-center gap-3">
            <div id="ava" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold"></div>
            <div class="flex-1 min-w-0">
                <p id="myName" class="text-sm font-bold truncate">...</p>
                <p id="myRole" class="text-xs text-slate-400 truncate">...</p>
            </div>
            <button onclick="logout()" class="text-slate-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-[#f1f5f9] overflow-hidden">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 z-10 shadow-sm">
            <h2 class="text-xl font-bold text-slate-800">–ï–¥–∏–Ω—ã–π –∂—É—Ä–Ω–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ v5.0</h2>
            <div class="flex gap-3">
                <button onclick="generateReport()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-purple-500/30 transition flex items-center gap-2">
                    <i class="fas fa-chart-line"></i> –û—Ç—á–µ—Ç
                </button>
                <button onclick="exportDocuments()" class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-orange-500/30 transition flex items-center gap-2">
                    <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
                </button>
                <button onclick="signAllDocuments()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-blue-500/30 transition flex items-center gap-2">
                    <i class="fas fa-signature"></i> –ü–æ–¥–ø–∏—Å–∞—Ç—å –≤—Å–µ
                </button>
                <button onclick="printJournal()" class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-emerald-500/30 transition flex items-center gap-2">
                    <i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å –∂—É—Ä–Ω–∞–ª–∞
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-8">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase">
                            <th class="px-6 py-4">‚Ññ</th>
                            <th class="px-6 py-4">–î–∞—Ç–∞</th>
                            <th class="px-6 py-4">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                            <th class="px-6 py-4">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
                            <th class="px-6 py-4">–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                            <th class="px-6 py-4">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-6 py-4">–ü–æ–¥–ø–∏—Å–∏</th>
                            <th class="px-6 py-4 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 text-sm text-slate-700"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ -->
    <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-2">–î–æ–∫—É–º–µ–Ω—Ç:</label>
                <div id="modalDocInfo" class="text-sm text-slate-600 bg-slate-50 p-2 rounded"></div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-2">–ü–æ–¥–ø–∏—Å—ã–≤–∞—é—â–∏–π:</label>
                <input type="text" id="signerName" class="w-full p-2 border border-slate-300 rounded" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-2">PIN-–∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                <input type="password" id="pinCode" class="w-full p-2 border border-slate-300 rounded" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN">
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="confirmSign" class="mr-2">
                    <span class="text-sm">–Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –ø–æ–¥–ø–∏—Å—å —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞</span>
                </label>
            </div>
            <div class="flex gap-3">
                <button onclick="confirmSignature()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded font-medium hover:bg-blue-700">
                    –ü–æ–¥–ø–∏—Å–∞—Ç—å
                </button>
                <button onclick="closeSignatureModal()" class="flex-1 bg-slate-300 text-slate-700 py-2 px-4 rounded font-medium hover:bg-slate-400">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDRMyiouLjL6oyQK5TIpr69b8mvCcq4uLE", authDomain: "blago-a6270.firebaseapp.com", databaseURL: "https://blago-a6270-default-rtdb.firebaseio.com", projectId: "blago-a6270", storageBucket: "blago-a6270.firebasestorage.app", messagingSenderId: "857823585303", appId: "1:857823585303:web:6ce2d1acff62b16ebd2852", measurementId: "G-YHWJPH8TF9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const user = JSON.parse(localStorage.getItem('blago_user'));
        if(!user) window.location.href = 'index.html';
        
        document.getElementById('myName').innerText = user.name;
        document.getElementById('myRole').innerText = user.role;
        document.getElementById('ava').innerText = user.name[0];
        document.getElementById('signerName').value = user.name;
        if(user.role==='admin') document.getElementById('adminBlock').classList.remove('hidden');
        function logout(){localStorage.removeItem('blago_user'); window.location.href='index.html';}

        let documentsData = [];
        let currentDocumentToSign = null;

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
        async function loadDocuments() {
            const docs = [];
            
            // –û—Ç–ø—Ä–∞–≤–∫–∏
            const shipments = await db.ref('shipments').once('value');
            shipments.forEach(s => {
                if(s.val()) docs.push({
                    id: s.key,
                    date: s.val().date,
                    type: '–û—Ç–ø—Ä–∞–≤–∫–∞',
                    description: `–û—Ç–ø—Ä–∞–≤–∫–∞ –≥—Ä—É–∑–∞ ${s.val().items}`,
                    responsible: s.val().createdBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    data: s.val(),
                    ref: 'shipments'
                });
            });
            
            // –°–∫–ª–∞–¥
            const inventory = await db.ref('inventory').once('value');
            inventory.forEach(i => {
                if(i.val()) docs.push({
                    id: i.key,
                    date: i.val().createdAt || new Date().toLocaleDateString('ru-RU'),
                    type: '–ü—Ä–∏—Ö–æ–¥',
                    description: `–ü—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ ${i.val().name}`,
                    responsible: i.val().createdBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    data: i.val(),
                    ref: 'inventory'
                });
            });
            
            // –ö–æ–º–∞–Ω–¥–∞
            const team = await db.ref('team').once('value');
            team.forEach(t => {
                if(t.val()) docs.push({
                    id: t.key,
                    date: t.val().createdAt || new Date().toLocaleDateString('ru-RU'),
                    type: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                    description: `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ${t.val().name}`,
                    responsible: t.val().createdBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    data: t.val(),
                    ref: 'team'
                });
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å–∏
            const signatures = await db.ref('signatures').once('value');
            const signatureData = signatures.val() || {};
            
            docs.sort((a,b) => new Date(b.date) - new Date(a.date));
            documentsData = docs;
            
            const tb = document.getElementById('tableBody');
            tb.innerHTML = docs.map((d, i) => {
                const signature = signatureData[d.id];
                const isSigned = signature && signature.status === 'signed';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞
                let statusClass = 'bg-gray-100 text-gray-600';
                let statusText = '–ß–µ—Ä–Ω–æ–≤–∏–∫';
                let statusIcon = 'fas fa-edit';
                
                if(isSigned) {
                    statusClass = 'bg-green-100 text-green-700';
                    statusText = '–ü–æ–¥–ø–∏—Å–∞–Ω';
                    statusIcon = 'fas fa-check-circle';
                } else if(signature && signature.status === 'pending') {
                    statusClass = 'bg-yellow-100 text-yellow-700';
                    statusText = '–ù–∞ –ø–æ–¥–ø–∏—Å–∏';
                    statusIcon = 'fas fa-clock';
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –µ–≥–æ —Ü–≤–µ—Ç
                const typeColors = {
                    '–û—Ç–ø—Ä–∞–≤–∫–∞': 'bg-blue-100 text-blue-700',
                    '–ü—Ä–∏—Ö–æ–¥': 'bg-emerald-100 text-emerald-700',
                    '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è': 'bg-purple-100 text-purple-700',
                    '–û–ø–µ—Ä–∞—Ü–∏—è': 'bg-orange-100 text-orange-700'
                };
                
                return `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <td class="px-6 py-4 font-bold text-slate-800">${i+1}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium">${d.date}</div>
                            ${d.entryDate ? `<div class="text-xs text-slate-500">–ó–∞–ø–∏—Å–∞–Ω–æ: ${d.entryDate}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${typeColors[d.type] || 'bg-gray-100 text-gray-700'}">
                                ${d.type}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-slate-700 max-w-xs truncate" title="${d.description}">
                                ${d.description}
                            </div>
                            ${d.ref ? `<div class="text-xs text-slate-500">–ò—Å—Ç–æ—á–Ω–∏–∫: ${d.ref}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-800">${d.responsible}</div>
                            ${d.createdBy ? `<div class="text-xs text-slate-500">–°–æ–∑–¥–∞–ª: ${d.createdBy}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">
                                <i class="${statusIcon} mr-1"></i>${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${isSigned ? `
                                <div class="text-xs">
                                    <div class="font-medium text-green-700">${signature.signerName}</div>
                                    <div class="text-slate-500">${new Date(signature.signedAt).toLocaleString('ru-RU')}</div>
                                </div>
                            ` : `
                                <div class="text-xs text-slate-500">
                                    <i class="fas fa-user-edit mr-1"></i>–û–∂–∏–¥–∞–µ—Ç
                                </div>
                            `}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex gap-2 justify-end">
                                <button onclick="printDoc('${d.id}', '${d.type}')" class="text-blue-500 hover:text-blue-700" title="–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button onclick="viewDocDetails('${d.id}')" class="text-purple-500 hover:text-purple-700" title="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!isSigned ? `<button onclick="signDocument('${d.id}')" class="text-green-500 hover:text-green-700" title="–ü–æ–¥–ø–∏—Å–∞—Ç—å">
                                    <i class="fas fa-signature"></i>
                                </button>` : `
                                    <button onclick="verifySignature('${d.id}')" class="text-emerald-500 hover:text-emerald-700" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
                            
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
        function signDocument(docId) {
            const doc = documentsData.find(d => d.id === docId);
            if(!doc) return;
            
            currentDocumentToSign = doc;
            document.getElementById('modalDocInfo').innerHTML = `
                <strong>${doc.type}</strong><br>
                ${doc.description}<br>
                <small>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${doc.responsible}</small>
            `;
            document.getElementById('signatureModal').classList.remove('hidden');
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏
        async function confirmSignature() {
            const pinCode = document.getElementById('pinCode').value;
            const confirmSign = document.getElementById('confirmSign').checked;
            
            if(!pinCode) {
                alert('–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥');
                return;
            }
            
            if(!confirmSign) {
                alert('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å –¥–æ–∫—É–º–µ–Ω—Ç–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ PIN-–∫–æ–¥–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è)
            if(pinCode !== '1234') { // –ü—Ä–∏–º–µ—Ä PIN-–∫–æ–¥–∞
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥');
                return;
            }
            
            const signature = {
                documentId: currentDocumentToSign.id,
                signerId: user.id,
                signerName: user.name,
                signerRole: user.role,
                signedAt: new Date().toISOString(),
                status: 'signed',
                signatureHash: generateSignatureHash(currentDocumentToSign)
            };
            
            try {
                await db.ref('signatures').child(currentDocumentToSign.id).set(signature);
                alert('–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω!');
                closeSignatureModal();
                loadDocuments();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–µ—à–∞ –ø–æ–¥–ø–∏—Å–∏
        function generateSignatureHash(doc) {
            const data = JSON.stringify(doc);
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        async function signAllDocuments() {
            if(confirm('–ü–æ–¥–ø–∏—Å–∞—Ç—å –≤—Å–µ –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã?')) {
                const signatures = await db.ref('signatures').once('value');
                const signatureData = signatures.val() || {};
                
                let signedCount = 0;
                for(const doc of documentsData) {
                    if(!signatureData[doc.id] || signatureData[doc.id].status !== 'signed') {
                        const signature = {
                            documentId: doc.id,
                            signerId: user.id,
                            signerName: user.name,
                            signerRole: user.role,
                            signedAt: new Date().toISOString(),
                            status: 'signed',
                            signatureHash: generateSignatureHash(doc)
                        };
                        
                        try {
                            await db.ref('signatures').child(doc.id).set(signature);
                            signedCount++;
                        } catch (error) {
                            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ${doc.id}:`, error);
                        }
                    }
                }
                
                alert(`–ü–æ–¥–ø–∏—Å–∞–Ω–æ ${signedCount} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤`);
                loadDocuments();
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        async function generateReport() {
            const w = window.open('','','width=900,height=1000');
            const currentDate = new Date().toLocaleDateString('ru-RU');
            
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const totalDocs = documentsData.length;
            const signedDocs = documentsData.filter(d => {
                const sig = signatures[d.id];
                return sig && sig.status === 'signed';
            }).length;
            const pendingDocs = totalDocs - signedDocs;
            
            const typeStats = {};
            documentsData.forEach(doc => {
                typeStats[doc.type] = (typeStats[doc.type] || 0) + 1;
            });
            
            w.document.write(`
                <html><head><title>–û—Ç—á–µ—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç—É</title>
                <style>
                    @page { size: A4; margin: 20mm; }
                    body { font-family: 'Times New Roman', serif; padding: 0; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
                    .section { margin: 20px 0; }
                    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                    .stat-card { border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
                    .stat-number { font-size: 24px; font-weight: bold; color: #2563eb; }
                    .stat-label { font-size: 12px; color: #666; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #000; padding: 8px; font-size: 12px; }
                    th { background: #f5f5f5; text-align: center; font-weight: bold; }
                </style>
                </head><body>
                <div class="header">
                    <h2>–í–û–õ–û–ù–¢–ï–†–°–ö–ê–Ø –ì–†–£–ü–ü–ê ¬´–ë–õ–ê–ì–û –î–ê–†–ò–¢–¨¬ª</h2>
                    <h3>–û–¢–ß–ï–¢ –ü–û –î–û–ö–£–ú–ï–ù–¢–û–û–ë–û–†–û–¢–£</h3>
                    <p>–ü–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ ${currentDate}</p>
                </div>
                
                <div class="section">
                    <h3>–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${totalDocs}</div>
                            <div class="stat-label">–í–°–ï–ì–û –î–û–ö–£–ú–ï–ù–¢–û–í</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${signedDocs}</div>
                            <div class="stat-label">–ü–û–î–ü–ò–°–ê–ù–û</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${pendingDocs}</div>
                            <div class="stat-label">–û–ñ–ò–î–ê–ï–¢ –ü–û–î–ü–ò–°–ò</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round((signedDocs/totalDocs)*100) || 0}%</div>
                            <div class="stat-label">–ü–†–û–¶–ï–ù–¢ –ü–û–î–ü–ò–°–ê–ù–ò–Ø</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –¢–ò–ü–ê–ú –î–û–ö–£–ú–ï–ù–¢–û–í</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(typeStats).map(([type, count]) => `
                                <tr>
                                    <td>${type}</td>
                                    <td style="text-align: center;">${count}</td>
                                    <td style="text-align: center;">${Math.round((count/totalDocs)*100)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h3>–î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>‚Ññ</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${documentsData.map((d, i) => {
                                const signature = signatures[d.id];
                                const isSigned = signature && signature.status === 'signed';
                                const statusText = isSigned ? '–ü–û–î–ü–ò–°–ê–ù' : '–û–ñ–ò–î–ê–ï–¢';
                                const statusClass = isSigned ? 'color: green;' : 'color: orange;';
                                
                                return `
                                    <tr>
                                        <td style="text-align: center;">${i+1}</td>
                                        <td>${d.date}</td>
                                        <td>${d.type}</td>
                                        <td>${d.description}</td>
                                        <td>${d.responsible}</td>
                                        <td style="${statusClass} font-weight: bold;">${statusText}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 50px; padding: 15px; border: 1px solid #ccc;">
                    <p><strong>–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                    <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${user.name} (${user.role})</p>
                    <p><strong>–°–∏—Å—Ç–µ–º–∞:</strong> –ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å v5.0</p>
                </div>
                </body></html>
            `);
            w.document.close();
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        async function exportDocuments() {
            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    exportedBy: user.name,
                    documents: documentsData.map(doc => ({
                        ...doc,
                        signature: signatures[doc.id] || null
                    }))
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `documents_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('–î–æ–∫—É–º–µ–Ω—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª JSON');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.add('hidden');
            document.getElementById('pinCode').value = '';
            document.getElementById('confirmSign').checked = false;
            currentDocumentToSign = null;
        }
        
        // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞
        function viewDocDetails(docId) {
            const doc = documentsData.find(d => d.id === docId);
            const signature = signatures[docId];
            
            if(!doc) return;
            
            const detailModal = document.createElement('div');
            detailModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            detailModal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="text-xl font-bold text-slate-800">–î–µ—Ç–∞–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Ññ ${docId}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                                <div class="text-slate-800 font-medium">${doc.type}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                                <div class="text-slate-800">${doc.date}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                                <div class="text-slate-800">${doc.responsible}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–°–æ–∑–¥–∞—Ç–µ–ª—å</label>
                                <div class="text-slate-800">${doc.createdBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <div class="text-slate-800 p-3 bg-slate-50 rounded-lg">${doc.description}</div>
                        </div>
                        
                        ${doc.data ? `
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
                                <div class="text-slate-800 p-3 bg-slate-50 rounded-lg">
                                    <pre class="text-xs">${JSON.stringify(doc.data, null, 2)}</pre>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${signature ? `
                            <div class="border-t border-slate-200 pt-4">
                                <h4 class="font-bold text-slate-800 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∏</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–ü–æ–¥–ø–∏—Å–∞–Ω—Ç</label>
                                        <div class="text-slate-800">${signature.signerName}</div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–†–æ–ª—å</label>
                                        <div class="text-slate-800">${signature.signerRole}</div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∏</label>
                                        <div class="text-slate-800">${new Date(signature.signedAt).toLocaleString('ru-RU')}</div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-500 uppercase mb-1">–•–µ—à –ø–æ–¥–ø–∏—Å–∏</label>
                                        <div class="text-slate-800 font-mono text-xs">${signature.signatureHash}</div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="border-t border-slate-200 pt-4">
                                <div class="text-yellow-600 text-center">
                                    <i class="fas fa-clock mr-2"></i>–î–æ–∫—É–º–µ–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏
                                </div>
                            </div>
                        `}
                    </div>
                    <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                        <button onclick="printDoc('${doc.id}', '${doc.type}'); this.closest('.fixed').remove();" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-print mr-2"></i>–ü–µ—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(detailModal);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
        function verifySignature(docId) {
            const doc = documentsData.find(d => d.id === docId);
            const signature = signatures[docId];
            
            if(!doc || !signature) {
                alert('–ü–æ–¥–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏
            const expectedHash = generateSignatureHash(doc);
            const isValid = expectedHash === signature.signatureHash;
            
            const w = window.open('','','width=600,height=400');
            w.document.write(`
                <html><head><title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏</title>
                <style>
                    body { font-family: 'Arial', sans-serif; padding: 20px; }
                    .valid { color: green; border: 2px solid green; padding: 15px; border-radius: 5px; }
                    .invalid { color: red; border: 2px solid red; padding: 15px; border-radius: 5px; }
                    .info { margin: 10px 0; }
                    .hash { font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 3px; }
                </style>
                </head><body>
                <h2>–ü–†–û–í–ï–†–ö–ê –≠–õ–ï–ö–¢–†–û–ù–ù–û–ô –ü–û–î–ü–ò–°–ò</h2>
                
                <div class="${isValid ? 'valid' : 'invalid'}">
                    <h3>${isValid ? '‚úì –ü–û–î–ü–ò–°–¨ –í–ï–†–ù–ê' : '‚úó –ü–û–î–ü–ò–°–¨ –ù–ï–í–ï–†–ù–ê'}</h3>
                    <p>${isValid ? '–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∏.' : '–î–æ–∫—É–º–µ–Ω—Ç –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –∏–ª–∏ –ø–æ–¥–ø–∏—Å—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞!'}</p>
                </div>
                
                <div class="info">
                    <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ:</h4>
                    <p><strong>ID:</strong> ${docId}</p>
                    <p><strong>–¢–∏–ø:</strong> ${doc.type}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${doc.date}</p>
                    <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${doc.responsible}</p>
                </div>
                
                <div class="info">
                    <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∏:</h4>
                    <p><strong>–ü–æ–¥–ø–∏—Å–∞–Ω—Ç:</strong> ${signature.signerName}</p>
                    <p><strong>–†–æ–ª—å:</strong> ${signature.signerRole}</p>
                    <p><strong>–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∏:</strong> ${new Date(signature.signedAt).toLocaleString('ru-RU')}</p>
                    <p><strong>–•–µ—à –ø–æ–¥–ø–∏—Å–∏:</strong></p>
                    <div class="hash">${signature.signatureHash}</div>
                </div>
                
                <div class="info">
                    <h4>–•–µ—à –¥–æ–∫—É–º–µ–Ω—Ç–∞:</h4>
                    <div class="hash">${expectedHash}</div>
                </div>
                
                <p style="margin-top: 30px; font-size: 12px; color: #666;">
                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: ${new Date().toLocaleString('ru-RU')}
                </p>
                </body></html>
            `);
            w.document.close();
        }
        
        function printDoc(id, type) {
            const w = window.open('','','width=900,height=1000');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            const doc = documentsData.find(d => d.id === id);
            const signature = doc ? doc.signature : null;
            
            w.document.write(`
                <html><head><title>–î–æ–∫—É–º–µ–Ω—Ç - ${type}</title>
                <style>
                    @page { size: A4; margin: 20mm; }
                    body { font-family: 'Times New Roman', serif; margin: 0; padding: 0; line-height: 1.4; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
                    .org { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
                    .doc-title { font-size: 24px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; }
                    .doc-info { margin-bottom: 20px; }
                    .doc-info p { margin: 5px 0; }
                    .signature-section { margin-top: 50px; display: flex; justify-content: space-between; }
                    .signature-box { width: 45%; border: 1px solid #000; padding: 15px; }
                    .signature-title { font-weight: bold; margin-bottom: 10px; }
                    .signature-line { margin-top: 20px; border-bottom: 1px solid #000; height: 30px; }
                    .footer { position: fixed; bottom: 10mm; right: 10mm; font-size: 10px; color: #666; }
                </style>
                </head><body>
                
                <div class="header">
                    <div class="org">–í–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∞—è –≥—Ä—É–ø–ø–∞ ¬´–ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å¬ª</div>
                    <div class="doc-title">–î–û–ö–£–ú–ï–ù–¢ - ${type}</div>
                </div>

                <div class="doc-info">
                    <p><strong>–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> ${id}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${doc?.date || new Date().toLocaleDateString('ru-RU')}</p>
                    <p><strong>–¢–∏–ø:</strong> ${type}</p>
                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${doc?.description || ''}</p>
                    <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${doc?.responsible || ''}</p>
                </div>

                <div style="margin: 30px 0;">
                    <h3>–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
                    <pre style="background: #f5f5f5; padding: 15px; border: 1px solid #ddd; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 11px;">
${JSON.stringify(doc?.data || {}, null, 2)}
                    </pre>
                </div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å:</div>
                        <div>–°—Ç–∞—Ç—É—Å: ${signature && signature.status === 'signed' ? '–ü–û–î–ü–ò–°–ê–ù' : '–ù–ï –ü–û–î–ü–ò–°–ê–ù'}</div>
                        ${signature && signature.status === 'signed' ? `
                            <div>–ü–æ–¥–ø–∏—Å–∞–ª: ${signature.signerName}</div>
                            <div>–†–æ–ª—å: ${signature.signerRole}</div>
                            <div>–î–∞—Ç–∞: ${new Date(signature.signedAt).toLocaleString('ru-RU')}</div>
                            <div>–•–µ—à: ${signature.signatureHash}</div>
                        ` : '<div>–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω</div>'}
                        <div class="signature-line"></div>
                        <div style="text-align: center; font-size: 12px;">–ü–æ–¥–ø–∏—Å—å</div>
                    </div>
                    
                    <div class="signature-box">
                        <div class="signature-title">–ü–µ—á–∞—Ç—å –∏ –ø–æ–¥–ø–∏—Å—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:</div>
                        <div class="signature-line"></div>
                        <div style="text-align: center; font-size: 12px; margin-top: 5px;">–ú.–ü.</div>
                        <div class="signature-line" style="margin-top: 30px;"></div>
                        <div style="text-align: center; font-size: 12px;">–ü–æ–¥–ø–∏—Å—å</div>
                    </div>
                </div>

                <div class="footer">
                    –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ "–ë–ª–∞–≥–æ –¥–∞—Ä–∏—Ç—å v4.5.0 PRO"<br>
                    –î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏: ${new Date().toLocaleString('ru-RU')}
                </div>

                </body></html>
            `);
            w.document.close();
        }
        
        function printJournal() {
            const w = window.open('','','width=900,height=1000');
            const currentDate = new Date().toLocaleDateString('ru-RU');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∏
            db.ref('signatures').once('value').then(snapshots => {
                const signatures = snapshots.val() || {};
                
                w.document.write(`
                    <html><head><title>–ñ—É—Ä–Ω–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
                    <style>
                        @page { size: A4; margin: 0; }
                        body { font-family: 'Times New Roman', serif; margin: 0; padding: 0; }
                        .page { width: 210mm; height: 296mm; padding: 20mm; box-sizing: border-box; page-break-after: always; position: relative; }
                        .cover-page { display: flex; flex-direction: column; justify-content: space-between; height: 100%; border: 3px solid #000; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
                        .cover-header { text-align: center; padding: 30px; }
                        .org { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: #0f766e; }
                        .logo { font-size: 48px; margin-bottom: 20px; }
                        .journal-name { font-size: 42px; font-weight: bold; margin: 30px 0; text-decoration: underline; color: #1e40af; }
                        .journal-subtitle { font-size: 18px; color: #64748b; margin-bottom: 40px; }
                        .cover-info { background: rgba(255,255,255,0.8); padding: 30px; margin: 0 30px; border-radius: 10px; border: 1px solid #cbd5e1; }
                        .info-row { display: flex; justify-content: space-between; margin: 15px 0; font-size: 16px; }
                        .cover-footer { text-align: center; padding: 20px; font-size: 18px; color: #64748b; }
                        
                        .content-page { height: auto; min-height: 296mm; }
                        .content-header { text-align: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #000; }
                        
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #000; padding: 8px; font-size: 11px; }
                        th { background: #f1f5f9; text-align: center; font-weight: bold; }
                        .status-signed { color: #059669; font-weight: bold; }
                        .status-pending { color: #d97706; font-weight: bold; }
                        
                        .footer { position: fixed; bottom: 10mm; right: 10mm; font-size: 10px; color: #666; }
                        .page-number { position: fixed; bottom: 10mm; left: 10mm; font-size: 10px; color: #666; }
                    </style>
                    </head><body>
                    
                    <!-- –û–±–ª–æ–∂–∫–∞ -->
                    <div class="page">
                        <div class="cover-page">
                            <div class="cover-header">
                                <div class="logo">üèõÔ∏è</div>
                                <div class="org">–í–û–õ–û–ù–¢–ï–†–°–ö–ê–Ø –ì–†–£–ü–ü–ê<br>¬´–ë–õ–ê–ì–û –î–ê–†–ò–¢–¨¬ª</div>
                            </div>
                            
                            <div class="cover-info">
                                <div class="journal-name">–ñ–£–†–ù–ê–õ –î–û–ö–£–ú–ï–ù–¢–û–í</div>
                                <div class="journal-subtitle">–ï–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
                                
                                <div class="info-row">
                                    <span><strong>–ù–∞—á–∞—Ç:</strong></span>
                                    <span>01.01.2026</span>
                                </div>
                                <div class="info-row">
                                    <span><strong>–û–∫–æ–Ω—á–µ–Ω:</strong></span>
                                    <span>_______________</span>
                                </div>
                                <div class="info-row">
                                    <span><strong>–í—Å–µ–≥–æ –ª–∏—Å—Ç–æ–≤:</strong></span>
                                    <span>_______________</span>
                                </div>
                                <div class="info-row">
                                    <span><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong></span>
                                    <span>${user.name}</span>
                                </div>
                                <div class="info-row">
                                    <span><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong></span>
                                    <span>${user.role}</span>
                                </div>
                            </div>
                            
                            <div class="cover-footer">
                                <strong>–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, 2026 –≥–æ–¥</strong><br>
                                <small>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–æ–º v4.5.0 PRO</small>
                            </div>
                        </div>
                    </div>

                    <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
                    <div class="page content-page">
                        <div class="content-header">
                            <h2>–°–û–î–ï–†–ñ–ê–ù–ò–ï –ñ–£–†–ù–ê–õ–ê –î–û–ö–£–ú–ï–ù–¢–û–í</h2>
                            <p>–ü–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ ${currentDate}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th width="5%">‚Ññ</th>
                                    <th width="10%">–î–∞—Ç–∞</th>
                                    <th width="12%">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                                    <th width="35%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                    <th width="15%">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                                    <th width="10%">–°—Ç–∞—Ç—É—Å</th>
                                    <th width="13%">–ü–æ–¥–ø–∏—Å—å</th>
                                </tr>
                            </thead>
                            <tbody id="journalBody">
                                ${documentsData.map((d, i) => {
                                    const signature = signatures[d.id];
                                    const isSigned = signature && signature.status === 'signed';
                                    const statusClass = isSigned ? 'status-signed' : 'status-pending';
                                    const statusText = isSigned ? '–ü–û–î–ü–ò–°–ê–ù' : '–û–ñ–ò–î–ê–ï–¢';
                                    
                                    return `
                                        <tr>
                                            <td style="text-align: center; font-weight: bold;">${i+1}</td>
                                            <td>${d.date}</td>
                                            <td>${d.type}</td>
                                            <td>${d.description}</td>
                                            <td>${d.responsible}</td>
                                            <td class="${statusClass}">${statusText}</td>
                                            <td>${isSigned ? signature.signerName : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                            <h4>–ò–¢–û–ì–û:</h4>
                            <p>‚Ä¢ –í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: <strong>${documentsData.length}</strong></p>
                            <p>‚Ä¢ –ü–æ–¥–ø–∏—Å–∞–Ω–æ: <strong>${Object.values(signatures).filter(s => s.status === 'signed').length}</strong></p>
                            <p>‚Ä¢ –û–∂–∏–¥–∞—é—Ç –ø–æ–¥–ø–∏—Å–∏: <strong>${documentsData.length - Object.values(signatures).filter(s => s.status === 'signed').length}</strong></p>
                        </div>
                        
                        <div class="footer">–õ–∏—Å—Ç 2</div>
                    </div>
                    </body></html>
                `);
                w.document.close();
            });
        }
        
        loadDocuments();
    </script>
</body>
</html>